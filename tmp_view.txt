import { Component, OnInit, inject } from '@angular/core';
import jsPDF from 'jspdf';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { UiAlertComponent } from '../../shared/ui/alert/alert';
import { UiConfirmComponent } from '../../shared/ui/confirm/confirm';
import { Manifiestos } from '../../../../core/services/manifiestos';
import { Envios } from '../../../../core/services/envios';
import { Puntos } from '../../../../core/services/puntos';
import { Conductores as ConductoresService } from '../../../../core/services/conductores';
import { Manifiesto, Envio, Puntos as Points, Persona, DetalleComprobante } from '../../../../core/mapped';
import { Conductor } from '../../../../core/mapped';
import { Personas } from '../../../../core/services/personas';
import { DetallesComprobante } from '../../../../core/services/detalles-comprobante';
import { forkJoin, of } from 'rxjs';
import { RouterLink } from '@angular/router';

export type FormManifiesto = { conductor_id: number | null; codigo_punto_origen: number | null; codigo_punto_destino: number | null; serie: string; numero: string; };

@Component({
  selector: 'feature-manifiestos',
  standalone: true,
  imports: [CommonModule, FormsModule, UiAlertComponent, UiConfirmComponent, RouterLink],
  templateUrl: './manifiestos.html',
  styleUrl: './manifiestos.css',
})
export class ManifiestosFeature implements OnInit {
  private readonly manifiestosSrv = inject(Manifiestos);
  private readonly puntosSrv = inject(Puntos);
  private readonly conductoresSrv = inject(ConductoresService);
  private readonly enviosSrv = inject(Envios);
  private readonly personasSrv = inject(Personas);
  private readonly detCompSrv = inject(DetallesComprobante);

  // Datos
  lista_manifiestos: Manifiesto[] = [];
  loading = false;
  error: string | null = null;

  // Filtros y paginación
  search = '';
  page = 1;
  pageSize = 8;

  // Vista: 'cards' o 'grid'
  viewMode: 'cards' | 'grid' = 'cards';

  // Modal y guardado
  showModal = false;
  saving = false;
  saveError: string | null = null;

  // Confirmación eliminacion
  confirmOpen = false;
  confirmTitle = 'Confirmar eliminación';
  confirmMessage = '';
  pendingDeleteId: number | null = null;
  pendingDeleteLabel: string = '';

  // Notificaciones
  notif: string | null = null;
  notifType: 'success' | 'error' = 'success';

  // Puntos y conductores
  puntos: Points[] = [];
  conductores: Conductor[] = [];
  personas: Persona[] = [];

  // Edición
  editing = false;
  editingId: number | null = null;

  // Ver envíos por manifiesto
  showEnviosModal = false;
  enviosLoading = false;
  enviosError: string | null = null;
  enviosLista: Envio[] = [];
  enviosManifiestoId: number | null = null;

  // Añadir envíos a manifiesto
  showAddEnviosModal = false;
  addEnviosLoading = false;
  addEnviosError: string | null = null;
  addEnviosLista: Envio[] = [];
  addManifiestoId: number | null = null;
  addSearch = '';
  get filteredAddEnvios(): Envio[] {
    const term = (this.addSearch || '').trim().toLowerCase();
    const list = (this.addEnviosLista || []).slice();
    if (!term) return list;
    return list.filter((e: any) => {
      const txt = [e?.id, e?.guia, e?.remitente, e?.destinatario, e?.peso, e?.fecha_envio]
        .map(x => String(x ?? '')).join(' ').toLowerCase();
      return txt.includes(term);
    });
  }

  // Lista filtrada
  get filteredManifiestos(): Manifiesto[] {
    const term = this.search.trim().toLowerCase();
    return (this.lista_manifiestos || []).filter((m: any) => {
      if (!term) return true;
      const values = [
        String(m.conductor_id ?? ''),
        String(m.codigo_punto_origen ?? ''),
        String(m.codigo_punto_destino ?? ''),
        String(m.serie ?? ''),
        String(m.numero ?? ''),
      ].join(' ').toLowerCase();
      return values.includes(term);
    });
  }

  // Paginación derivada
  get total(): number { return this.filteredManifiestos.length; }
  get totalPages(): number { return Math.max(1, Math.ceil(this.total / this.pageSize)); }
  get pageItems(): Manifiesto[] {
    const start = (this.page - 1) * this.pageSize;
    return this.filteredManifiestos.slice(start, start + this.pageSize);
  }
  get pageStart(): number { return this.total ? (this.page - 1) * this.pageSize + 1 : 0; }
  get pageEnd(): number { return Math.min(this.page * this.pageSize, this.total); }
  setPage(n: number) { this.page = Math.min(Math.max(1, n), this.totalPages); }
  onFilterChange() { this.page = 1; }

  newManifiesto: FormManifiesto = { conductor_id: null, codigo_punto_origen: null, codigo_punto_destino: null, serie: '', numero: '' };

  // Modal helpers
  openModal() {
    this.editing = false;
    this.editingId = null;
    this.newManifiesto = { conductor_id: null, codigo_punto_origen: null, codigo_punto_destino: null, serie: '', numero: '' };
    this.saveError = null;
    this.showModal = true;
  }
  openEdit(item: Manifiesto) {
    this.editing = true;
    this.editingId = (item as any).id ?? null;
    this.newManifiesto = {
      conductor_id: (item as any).conductor_id ?? null,
      codigo_punto_origen: (item as any).codigo_punto_origen ?? null,
      codigo_punto_destino: (item as any).codigo_punto_destino ?? null,
      serie: (item as any).serie ?? '',
      numero: (item as any).numero ?? '',
    };
    this.saveError = null;
    this.showModal = true;
  }
  closeModal() { this.showModal = false; }

  get isValidManifiesto(): boolean {
    const m = this.newManifiesto;
    const okConductor = Number(m.conductor_id) > 0;
    const okOrigen = Number(m?.codigo_punto_origen) > 0;
    const okDestino = Number(m.codigo_punto_destino) > 0;
    const okSerie = String(m.serie || '').trim().length > 0;
    const okNumero = String(m.numero || '').trim().length > 0;
    return okConductor && okOrigen && okDestino && okSerie && okNumero;
  }

  submitManifiesto() {
    if (!this.isValidManifiesto) return;
    const m = this.newManifiesto;
    const payload = {
      conductor_id: Number(m.conductor_id),
      codigo_punto_origen: Number(m.codigo_punto_origen),
      codigo_punto_destino: Number(m.codigo_punto_destino),
      serie: String(m.serie || '').trim(),
      numero: String(m.numero || '').trim(),
    };
    this.saving = true;
    this.saveError = null;
    const obs = this.editing && this.editingId
      ? this.manifiestosSrv.updateManifiestos(this.editingId, payload)
      : this.manifiestosSrv.createManifiestos(payload);
    obs.subscribe({
      next: (res: any) => {
        const updated: any = {
          id: res?.id ?? (this.editingId ?? Math.max(0, ...(this.lista_manifiestos.map((x:any)=>x.id).filter(Number))) + 1),
          conductor_id: res?.conductor_id ?? payload.conductor_id,
          codigo_punto_origen: res?.codigo_punto_origen ?? payload.codigo_punto_origen,
          codigo_punto_destino: res?.codigo_punto_destino ?? payload.codigo_punto_destino,
          serie: res?.serie ?? payload.serie,
          numero: res?.numero ?? payload.numero,
        };
        if (this.editing && this.editingId) {
          this.lista_manifiestos = this.lista_manifiestos.map((mm:any) => mm.id === this.editingId ? updated : mm);
        } else {
          this.lista_manifiestos = [updated, ...this.lista_manifiestos];
        }
        const wasEditing = this.editing;
        this.saving = false;
        this.editing = false;
        this.editingId = null;
        this.onFilterChange();
        this.closeModal();
        this.showNotif(wasEditing ? 'Manifiesto actualizado' : 'Manifiesto creado');
      },
      error: () => {
        this.saving = false;
        this.saveError = this.editing ? 'No se pudo actualizar' : 'No se pudo crear el manifiesto';
        this.showNotif('No se pudo crear/actualizar el manifiesto', 'error');
      }
    });
  }

  askDelete(item: Manifiesto) {
    this.pendingDeleteId = (item as any).id ?? null;
    this.pendingDeleteLabel = `${(item as any).serie || ''}-${(item as any).numero || ''}`;
    this.confirmMessage = `¿Eliminar manifiesto ${this.pendingDeleteLabel}?`;
    this.confirmOpen = true;
  }
  onCancelDelete() {
    this.confirmOpen = false;
    this.pendingDeleteId = null;
    this.pendingDeleteLabel = '';
  }
  onConfirmDelete() {
    const id = this.pendingDeleteId;
    if (!id) { this.onCancelDelete(); return; }
    this.saving = true;
    this.manifiestosSrv.deleteManifiestos(id).subscribe({
      next: () => {
        this.lista_manifiestos = this.lista_manifiestos.filter((mm:any) => mm.id !== id);
        this.saving = false;
        this.onFilterChange();
        this.onCancelDelete();
        this.showNotif('Manifiesto eliminado');
      },
      error: () => {
        this.saving = false;
        this.saveError = 'No se pudo eliminar el manifiesto';
        this.onCancelDelete();
        this.showNotif('No se pudo eliminar el manifiesto', 'error');
      }
    });
  }

  showNotif(msg: string, type: 'success' | 'error' = 'success') {
    this.notifType = type;
    this.notif = msg;
    setTimeout(() => { this.notif = null; }, 3000);
  }

  loadManifiestos() {
    this.loading = true;
    this.error = null;
    this.manifiestosSrv.getManifiestos().subscribe({
      next: (response) => { this.lista_manifiestos = (response as any) || []; this.loading = false; },
      error: () => { this.loading = false; this.error = 'No se pudieron cargar los manifiestos'; },
    });
  }

  safeOrigen(item: any): number | null {
    return item?.codigo_punto_origen ?? null;
  }
  safeDestino(item: any): number | null {
    return item?.codigo_punto_destino ?? null;
  }

  loadPuntos() {
    this.puntosSrv.getPuntos().subscribe({
      next: (res: Points[]) => { this.puntos = res || []; },
      error: () => { /* noop */ },
    });
  }

  nameFrom(id: number | null): string {
    if (!id) return '';
    const f = (this.puntos || []).find((p:any) => p.id === id);
    return (f as any)?.nombre || String(id);
  }

  loadConductores() {
    this.conductoresSrv.getConductores().subscribe({
      next: (res) => { this.conductores = res || []; },
      error: () => { this.conductores = []; },
    });
  }
  loadPersonas() {
    this.personasSrv.getPersonas().subscribe({
      next: (res) => { this.personas = res || []; },
      error: () => { this.personas = []; },
    });
  }

  conductorLabel(id: number | null | undefined): string {
    if (!id) return '';
    const c = (this.conductores || []).find((cc:any) => cc.id === id);
    if (!c) return String(id);
    return `${c.licencia || 'Conductor'} - ${c.tipo_licencia || ''}`.trim();
  }


  
  setView(mode: 'cards' | 'grid') {
    this.viewMode = mode;
    try { localStorage.setItem('manifiestos.viewMode', mode); } catch {}
  }

ngOnInit(): void {
    try { const saved = (localStorage.getItem('manifiestos.viewMode') || '').toLowerCase(); if (saved === 'grid' || saved === 'cards') this.viewMode = saved as any; } catch {}
    this.loadManifiestos();
    this.loadPuntos();
    this.loadConductores();
    this.loadPersonas();
  }

  // Acciones tarjeta
  verEnvios(item: Manifiesto) { this.showGuiaModal = false; this.showAddEnviosModal = false;
    const id = (item as any)?.id;
    if (!id) return;
    this.enviosManifiestoId = id as any;
    this.enviosLoading = true;
    this.enviosError = null;
    this.enviosLista = [];
    this.showEnviosModal = true;
    this.enviosSrv.getEnviosManifiesto(Number(id)).subscribe({
      next: (res) => { this.enviosLista = res || []; this.enviosLoading = false; },
      error: () => { this.enviosLoading = false; this.enviosError = 'No se pudieron cargar los envíos'; }
    });
  }
  closeEnvios() { this.showEnviosModal = false; }

  // Generar guía
  showGuiaModal = false;
  guiaLoading = false;
  guiaError: string | null = null;
  guiaItems: { envio: Envio, detalles: DetalleComprobante[] }[] = [];
  guiaManifiestoId: number | null = null;
  guiaSerie: string = '';
  guiaNumero: string = '';
  guiaOrigenId: number | null = null;
  guiaDestinoId: number | null = null;
  guiaConductorId: number | null = null;

  generarGuia(item: Manifiesto) { this.showEnviosModal = false; this.showAddEnviosModal = false;
    const id = (item as any)?.id;
    if (!id) return;
    this.guiaManifiestoId = Number(id);
    this.guiaSerie = String(((item as any).serie || ''));
    this.guiaNumero = String(((item as any).numero || ''));
    this.guiaOrigenId = this.safeOrigen(item as any);
    this.guiaDestinoId = this.safeDestino(item as any);
    this.guiaConductorId = (item as any).conductor_id ?? null;
    this.showGuiaModal = true;
    this.guiaLoading = true;
    this.guiaError = null;
    this.guiaItems = [];
    this.enviosSrv.getEnviosManifiesto(Number(id)).subscribe({
      next: (envs: any[]) => {
        const envios = envs || [];
        const calls = envios.map((e:any) => (e?.comprobante_id ? this.detCompSrv.getDetalles(Number(e.comprobante_id)) : of([])));
        forkJoin(calls).subscribe({
          next: (detList: any[]) => {
            this.guiaItems = envios.map((e:any, idx:number) => ({ envio: e as any, detalles: (detList[idx] || []) as any[] }));
            this.guiaLoading = false;
          },
          error: () => { this.guiaLoading = false; this.guiaError = 'No se pudieron cargar los detalles de comprobante'; }
        });
      },
      error: () => { this.guiaLoading = false; this.guiaError = 'No se pudieron cargar los envíos del manifiesto'; }
    });
  }
  closeGuia() { this.showGuiaModal = false; }

  exportGuiaPDF() {
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    let y = 40;
    const marginX = 40; const line = 16;
    const add = (t:string, bold=false) => { doc.setFont('helvetica', bold?'bold':'normal'); doc.text(t, marginX, y); y += line; };
    add('Manifiesto ' + (this.guiaSerie || '') + '-' + (this.guiaNumero || ''), true);
    add('Conductor: ' + this.conductorLabel(this.guiaConductorId), false);
    add('Origen: ' + this.nameFrom(this.guiaOrigenId) + '   Destino: ' + this.nameFrom(this.guiaDestinoId), false);
    (this.guiaItems || []).forEach((g, gi) => {
      if (y > 760) { doc.addPage(); y = 40; }
      add('Envío: ' + (((g as any).envio?.guia ?? (g as any).envio?.id) || ''), true);
      const dets:any[] = (g as any).detalles || [];
      if (!dets.length) { add('Sin detalle'); return; }
      doc.setFont('helvetica','bold');
      doc.text('Ítem', marginX, y); doc.text('Cant.', marginX+50, y); doc.text('Descripción', marginX+110, y); doc.text('P. Unit', marginX+360, y); doc.text('Subtotal', marginX+450, y); y += 8; doc.line(marginX, y, marginX+520, y); y += 12; doc.setFont('helvetica','normal');
      dets.forEach((d:any) => {
        if (y > 780) { doc.addPage(); y = 40; }
        const subtotal = (Number(d.cantidad)||0) * (Number(d.precio_unitario)||0);
        doc.text(String(d.numero_item ?? ''), marginX, y);
        doc.text(String(d.cantidad ?? ''), marginX+50, y);
        doc.text(String(d.descripcion ?? ''), marginX+110, y, { maxWidth: 220 });
        doc.text(String(Number(d.precio_unitario||0).toFixed(2)), marginX+360, y);
        doc.text(String(Number(subtotal).toFixed(2)), marginX+450, y);
        y += 14;
      });
      y += 6;
    });
    // Firmas
    y += 20; if (y > 700) { doc.addPage(); y = 60; }
    // Conductor
    doc.setLineWidth(0.5);
    doc.line(marginX+40, y+2, marginX+280, y+2);
    doc.text('Firma del Conductor', marginX+80, y+16);
    doc.text(String(this.conductorLabel(this.guiaConductorId)), marginX+60, y-6);
    // Recibido por
    y += 50; if (y > 760) { doc.addPage(); y = 60; }
    const allDests = ((this.guiaItems||[]) as any[]).map((g:any)=> (this.personaLabelById((g as any).envio?.destinatario) || "").trim()).filter((n:string)=> !!n);
    const uniq = Array.from(new Set(allDests));
    let destShow = "";
    if (uniq.length === 1) { destShow = uniq[0]; }
    else if (uniq.length > 1 && uniq.length <= 3) { destShow = uniq.join(", "); }
    else if (uniq.length > 3) { destShow = uniq.slice(0,3).join(", ") + " +" + (uniq.length-3) + " más"; }
    doc.line(marginX+40, y+2, marginX+280, y+2);
    if (destShow) { doc.text('Recibido por: ' + destShow, marginX+60, y-6); }
    doc.text('Recibido por', marginX+110, y+16);
    const today = new Date(); const f = today.getFullYear()+"-"+String(today.getMonth()+1).padStart(2,"0")+"-"+String(today.getDate()).padStart(2,"0");
    doc.text('Fecha: ' + f, marginX+340, y+6);
    const fname = `guia_manifiesto_${this.guiaSerie || ''}-${this.guiaNumero || ''}.pdf`;
    doc.save(fname);
  }

  anadirEnvio(item: Manifiesto) { this.showGuiaModal = false; this.showEnviosModal = false;
    const id = (item as any)?.id;
    if (!id) return;
    this.addManifiestoId = Number(id);
    this.showAddEnviosModal = true;
    this.addEnviosLoading = true;
    this.addEnviosError = null;
    this.addEnviosLista = [];
    this.enviosSrv.getEnvios().subscribe({
      next: (res) => {
        const all = (res || []) as any[];
        this.addEnviosLista = all.filter(e => (e as any)?.manifiesto == null);
        this.addEnviosLoading = false;
      },
      error: () => { this.addEnviosLoading = false; this.addEnviosError = 'No se pudieron cargar los envíos'; }
    });
  }

  closeAddEnvios() { this.showAddEnviosModal = false; }
  attachEnvioToManifiesto(envio: Envio) {
    const mid = this.addManifiestoId;
    const eid = (envio as any)?.id;
    if (!mid || !eid) return;
    this.addEnviosLoading = true;
    this.enviosSrv.updateEnvios(Number(eid), { manifiesto: Number(mid) } as any).subscribe({
      next: () => {
        this.addEnviosLoading = false;
        this.addEnviosLista = (this.addEnviosLista || []).filter((e:any) => e.id !== eid);
        this.showNotif('Envío añadido al manifiesto');
      },
      error: () => { this.addEnviosLoading = false; this.showNotif('No se pudo añadir', 'error'); }
    });
  }

  personaLabelById(id: number | null | undefined): string {
    if (!id) return '';
    const f = (this.personas || []).find((pp: any) => Number(pp.id) === Number(id));
    if (!f) return String(id);
    const nombre = [f?.nombre, f?.apellido].filter(Boolean).join(' ').trim();
    const razon = (f?.razon_social || '').trim();
    const base = (razon || nombre || '').trim();
    const doc = (f?.nro_documento || '').trim();
    return [base, doc].filter(Boolean).join(' - ');
  }
}







