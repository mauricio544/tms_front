<div class="px-4 pt-4 pb-0">
  <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">Env&iacute;os</h1>
      <p class="mt-1 text-slate-600">Órdenes y tracking.</p>
    </div>
    <ui-alert [show]="!!notif" [message]="notif || ''" [type]="notifType" [autoHideMs]="3000"
              (closed)="notif=null"></ui-alert>
  </div>
  <div class="flex flex-wrap items-center gap-2">
    <input type="text" [(ngModel)]="search" (ngModelChange)="onFilterChange()" placeholder="Buscar envío"
           class="h-10 w-64 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-800 focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
    <select [(ngModel)]="pageSize" (ngModelChange)="setPage(1)"
            class="h-10 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-800 focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]">
      <option [ngValue]="8">8</option>
      <option [ngValue]="12">12</option>
      <option [ngValue]="20">20</option>
    </select>
    <select [(ngModel)]="entregaFilter" (ngModelChange)="onFilterChange()"
            class="h-10 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-800 focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]">
      <option [ngValue]="'all'">Todos</option>
      <option [ngValue]="'delivered'">Entregados</option>
      <option [ngValue]="'pending'">Pendientes</option>
    </select>
    <select [(ngModel)]="personaSearchTarget" (ngModelChange)="onFilterChange()"
            class="h-10 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-800 focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]">
      <option [ngValue]="'both'">Rem/Dest</option>
      <option [ngValue]="'remitente'">Remitente</option>
      <option [ngValue]="'destinatario'">Destinatario</option>
    </select>
    <select [(ngModel)]="origenFilterId" (ngModelChange)="onFilterChange()"
            class="h-10 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-800 focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]">
      <option [ngValue]="null">Origen: Todos</option>
      <option *ngFor="let p of puntos" [ngValue]="p.id">{{ p.nombre }}</option>
    </select>
    <select [(ngModel)]="destinoFilterId" (ngModelChange)="onFilterChange()"
            class="h-10 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-800 focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]">
      <option [ngValue]="null">Destino: Todos</option>
      <option *ngFor="let p of puntos" [ngValue]="p.id">{{ p.nombre }}</option>
    </select>
    <button (click)="openCreate()"
            class="inline-flex items-center rounded-md bg-[#21D0B2] px-3 py-2 text-sm font-medium text-white hover:bg-[#21D0B2]/90 focus:outline-none focus:ring-2 focus:ring-[#26A69A]">
      Nuevo
    </button>
    <!--Toggle Cards/grid-->
    <div class="ml-auto inline-flex rounded-md border border-slate-300 overflow-hidden">
      <button type="button" (click)="setViewMode('cards')" [class.bg-[#2F455C]]="viewMode==='cards'"
              [class.text-white]="viewMode==='cards'" class="px-3 py-2 text-sm">Tarjetas
      </button>
      <button type="button" (click)="setViewMode('table')" [class.bg-[#2F455C]]="viewMode==='table'"
              [class.text-white]="viewMode==='table'" class="border-l border-slate-300 px-3 py-2 text-sm">Tabla
      </button>
    </div>
    <!--End Toggle-->
  </div>
</div>

<!--Nuevo Envío-->
<div *ngIf="showCreate" class="px-4 mt-4">
  <div class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-slate-800">Nuevo env&iacute;o</h3>
    <div class="mt-4 space-y-4">
      <div class="grid grid-cols-2 gap-3">
        <!--control remitente-->
        <div class="relative" (click)="$event.stopPropagation()">
          <label class="block text-sm text-slate-700">Remitente</label>
          <div class="mt-2 grid grid-cols-[auto,1fr,auto,auto] items-center gap-2">
            <select [(ngModel)]="remitenteDocType" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm">
              <option [ngValue]="'RUC'">RUC</option>
              <option [ngValue]="'DNI'">DNI</option>
            </select>
            <input type="text" [(ngModel)]="remitenteDocNumber" (keydown.enter)="lookupRemitente()" placeholder="Nro documento"
                   class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
            <button type="button" (click)="lookupRemitente()" [disabled]="remLookupLoading"
                    class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-white/60">{{ remLookupLoading ? 'Buscando...' : 'Buscar' }}
            </button>
          </div>
          <div class="mt-1 relative">
            <div class="flex items-center gap-2">
              <input type="text" [(ngModel)]="remitenteQuery" (focus)="showRemitenteOptions=true"
                     (input)="showRemitenteOptions=true" readonly disabled
                     class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
              <button type="button" (click)="clearRemitente()"
                      class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Limpiar
              </button>
            </div>
            <div *ngIf="showRemitenteOptions"
                 class="absolute left-0 right-0 top-full z-10 mt-1 max-h-56 w-full overflow-auto rounded-md border border-slate-200 bg-white shadow">
              <div *ngIf="personasLoading" class="px-3 py-2 text-sm text-slate-500">Cargando...</div>
              <div *ngIf="personasError" class="px-3 py-2 text-sm text-red-600">{{ personasError }}</div>
              <button *ngFor="let p of filteredRemitentes" type="button" (click)="selectRemitente(p)"
                      class="block w-full px-3 py-2 text-left text-sm hover:bg-white/60">{{ personaLabel(p) }}
              </button>
              <div *ngIf="!personasLoading && !filteredRemitentes.length" class="px-3 py-2 text-sm text-slate-500">Sin
                resultados
              </div>
            </div>
          </div>

          <div class="text-xs text-red-600 mt-1" *ngIf="remLookupError">{{ remLookupError }}</div>
        </div>

        <!--control destinatario-->
        <div class="relative" (click)="$event.stopPropagation()">
          <label class="block text-sm text-slate-700">Destinatario</label>
          <div class="mt-2 grid grid-cols-[auto,1fr,auto] items-center gap-2">
            <select [(ngModel)]="destinatarioDocType"
                    class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm">
              <option [ngValue]="'RUC'">RUC</option>
              <option [ngValue]="'DNI'">DNI</option>
            </select>
            <input type="text" [(ngModel)]="destinatarioDocNumber" (keydown.enter)="lookupDestinatario()" placeholder="Nro documento"
                   class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
            <button type="button" (click)="lookupDestinatario()" [disabled]="destLookupLoading"
                    class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-white/60">{{ destLookupLoading ? 'Buscando...' : 'Buscar' }}
            </button>
          </div>
          <div class="mt-1 relative">
            <div class="flex items-center gap-2">
              <input type="text" [(ngModel)]="destinatarioQuery" (focus)="showDestinatarioOptions=true"
                     (input)="showDestinatarioOptions=true" readonly disabled
                     class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
              <button type="button" (click)="clearDestinatario()"
                      class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Limpiar
              </button>
            </div>
            <div *ngIf="showDestinatarioOptions"
                 class="absolute left-0 right-0 top-full z-10 mt-1 max-h-56 w-full overflow-auto rounded-md border border-slate-200 bg-white shadow">
              <div *ngIf="personasLoading" class="px-3 py-2 text-sm text-slate-500">Cargando...</div>
              <div *ngIf="personasError" class="px-3 py-2 text-sm text-red-600">{{ personasError }}</div>
              <button *ngFor="let p of filteredDestinatarios" type="button" (click)="selectDestinatario(p)"
                      class="block w-full px-3 py-2 text-left text-sm hover:bg-white/60">{{ personaLabel(p) }}
              </button>
              <div *ngIf="!personasLoading && !filteredDestinatarios.length" class="px-3 py-2 text-sm text-slate-500">
                Sin resultados
              </div>
            </div>
          </div>
          <div class="text-xs text-red-600 mt-1" *ngIf="destLookupError">{{ destLookupError }}</div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm text-slate-700">Peso (kg)</label>
          <input type="number" min="0" step="0.01" [(ngModel)]="newEnvio.peso" placeholder="0.00"
                 class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
        </div>
        <div>


          <label class="block text-sm text-slate-700">Fecha envío</label>


          <input type="date" [(ngModel)]="newEnvio.fecha_envio"
                 class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        </div>


        <div>


          <label class="block text-sm text-slate-700">Fecha recepci&oacute;n</label>


          <input type="date" [(ngModel)]="newEnvio.fecha_recepcion"
                 class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        </div>


      </div>


      <div class="grid grid-cols-2 gap-3">


        <div>


          <label class="block text-sm text-slate-700">Origen</label>


          <select [(ngModel)]="newEnvio.punto_origen_id"
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]" (ngModelChange)="onOrigenChange($event)">


            <option [ngValue]="null">Seleccione...</option>


            <option *ngFor="let p of puntos" [ngValue]="p.id" [disabled]="p.id === newEnvio.punto_destino_id">{{ p.nombre }}</option>


          </select>


          <div class="text-xs text-slate-500 mt-1" *ngIf="puntosLoading">Cargando puntos...</div>


          <div class="text-xs text-red-600 mt-1" *ngIf="puntosError">{{ puntosError }}</div>


        </div>


        <div>


          <label class="block text-sm text-slate-700">Destino</label>


          <select [(ngModel)]="newEnvio.punto_destino_id"
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]" (ngModelChange)="onDestinoChange($event)">


            <option [ngValue]="null">Seleccione...</option>


            <option *ngFor="let p of puntos" [ngValue]="p.id" [disabled]="p.id === newEnvio.punto_origen_id">{{ p.nombre }}</option>


          </select>


        </div>


      </div>


      <!-- Comprobante inline (mostrar solo si pagado) -->


      <div *ngIf="newEnvio.estado_pago"
           class="mt-4 rounded-md border border-[#26A69A] bg-[#26A69A]/10 ring-1 ring-[#26A69A]/20 p-4 shadow-sm border-l-4 border-l-[#26A69A]">


        <div class="text-sm font-semibold text-[#0A1A2F] mb-2">Comprobante</div>


        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">


          <div>


            <label class="block text-sm text-slate-700">Tipo</label>


            <select [(ngModel)]="compTipoSel" (ngModelChange)="onCompTipoChange($event)"
                    class="mt-1 w-full rounded-md border border-slate-300 px-2 py-2 text-sm">


              <option [ngValue]="null">Seleccione...</option>


              <option *ngFor="let t of compTipos" [ngValue]="t">{{ t.nombre }}</option>


            </select>


          </div>


          <div>


            <label class="block text-sm text-slate-700">Serie</label>


            <input type="text" [value]="compSerie" readonly
                   class="mt-1 w-full rounded-md border border-slate-300 bg-white/60 px-2 py-2 text-sm"/>


          </div>


          <div>


            <label class="block text-sm text-slate-700">N&uacute;mero</label>


            <input type="text" [value]="compNumeroComprobante" readonly
                   class="mt-1 w-full rounded-md border border-slate-300 bg-white/60 px-2 py-2 text-sm"/>


          </div>


          <div>


            <label class="block text-sm text-slate-700">Forma de pago</label>


            <select [(ngModel)]="compFormaPagoId"
                    class="mt-1 w-full rounded-md border border-slate-300 px-2 py-2 text-sm">


              <option [ngValue]="null">Seleccione...</option>


              <option *ngFor="let p of payTipos" [ngValue]="p.id">{{ p.nombre }}</option>


            </select>


          </div>


          <div>


            <label class="block text-sm text-slate-700">Fecha pago</label>


            <input type="date" [(ngModel)]="compFechaPago"
                   class="mt-1 w-full rounded-md border border-slate-300 px-2 py-2 text-sm"/>


          </div>


          <div class="sm:col-span-3"></div>


        </div>


        <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">


          <div class="sm:col-span-2">


            <label class="block text-sm text-slate-700">Cliente ({{ compDocType }})</label>


            <div class="mt-1 grid grid-cols-[auto,1fr,auto] items-center gap-2">


              <select [(ngModel)]="compDocType" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm">


                <option [ngValue]="'DNI'">DNI</option>


                <option [ngValue]="'RUC'">RUC</option>


              </select>


              <input type="text" [(ngModel)]="compDocNumber" placeholder="Documento"
                     class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


              <button type="button" (click)="lookupCliente()" [disabled]="compLookupLoading"
                      class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-white/60">{{ compLookupLoading ? 'Buscando...' : 'Buscar' }}
              </button>


            </div>


            <span *ngIf="compClienteId"
                  class="text-xs text-slate-600 pl-1 truncate max-w-[14rem]">{{ compClienteLabel() }}</span>


            <div class="text-xs text-red-600 mt-1" *ngIf="compLookupError">{{ compLookupError }}</div>


          </div>


          <div>


            <label class="block text-sm text-slate-700">Impuesto</label>


            <input type="text" [value]="compImpuesto | number:'1.2-2'" readonly
                   class="mt-1 w-full rounded-md border border-slate-300 bg-white/60 px-2 py-2 text-sm"/>


          </div>


        </div>

        <!-- Detalle del envío para cálculo del comprobante -->
      <div *ngIf="detallesLoading" class="mt-3 text-sm text-slate-500">Cargando detalle…</div>
        <div *ngIf="!detallesLoading && stagedDetalles.length" class="mt-3 overflow-x-auto border-1">
          <div style="width: 100%; height: 1px; background: #263238; position: relative;"></div>
          <h4 class="text-sm font-medium text-slate-800 mb-1">Detalle del env&iacute;o</h4>
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr>
                <th class="px-2 py-1">#</th>
                <th class="px-2 py-1">Cantidad</th>
                <th class="px-2 py-1">Descripci&oacute;n</th>
                <th class="px-2 py-1">P. Unitario</th>
                <th class="px-2 py-1">Subtotal</th>
              </tr>
            </thead>
            <tbody class="text-slate-800">
              <tr *ngFor="let d of stagedDetalles; index as i" class="border-t border-slate-100">
                <td class="px-2 py-1">{{ i + 1 }}</td>
                <td class="px-2 py-1">{{ d.cantidad }}</td>
                <td class="px-2 py-1">{{ d.descripcion }}</td>
                <td class="px-2 py-1">{{ d.precio_unitario | number:'1.2-2' }}</td>
                <td class="px-2 py-1">{{ (d.cantidad * d.precio_unitario) | number:'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
          <div class="mt-1 text-xs text-slate-500">Este detalle se usa para calcular el total e impuesto.</div>
        <div *ngIf="!detallesLoading && !stagedDetalles.length" class="mt-3 rounded-md border border-dashed border-slate-300 bg-white px-3 py-3 text-sm text-slate-500">
          Sin &iacute;tems para facturar.
        </div>
        </div>
        <div class="mt-2 text-right text-sm text-slate-700">Total: {{ compTotal | number:'1.2-2' }}</div>


        <div class="mt-1 text-right text-sm text-slate-700" *ngIf="compTipoNombre().toLowerCase().includes('fact')">
          Total (con impuesto): {{ compTotalConImpuesto | number:'1.2-2' }}
        </div>


        <div class="mt-2 text-right text-xs text-slate-500" *ngIf="!compValid">Complete tipo, forma de pago y
          documento
        </div>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Clave de recojo</label>


        <input type="text" [(ngModel)]="newEnvio.clave_recojo" placeholder="CLV-XXXX"
               class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


      </div>


      <div class="grid grid-cols-2 gap-3">


        <label class="inline-flex items-center gap-2 text-sm text-slate-700">


          <input type="checkbox" [(ngModel)]="newEnvio.estado_pago" class="h-4 w-4 accent-[#2F455C]"/>


          Pagado


        </label>


        <label class="inline-flex items-center gap-2 text-sm text-slate-700">


          <input type="checkbox" [(ngModel)]="newEnvio.tipo_contenido" class="h-4 w-4 accent-[#2F455C]"/>


          Contenido especial


        </label>


      </div>

      <div class="grid grid-cols-2 gap-3 mt-2">
        <label class="inline-flex items-center gap-2 text-sm text-slate-700">
          <input type="checkbox" [(ngModel)]="sendWhatsapp" class="h-4 w-4 accent-[#2F455C]"/>
          Enviar WhatsApp
        </label>
        <div *ngIf="sendWhatsapp">
          <input type="text" [(ngModel)]="whatsappPhone" placeholder="Celular (sin +51)" class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
                 class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
        </div>
      </div>


      <div *ngIf="!editing" class="mt-6 detalle-envio-resaltado">


        <h4 class="text-sm font-medium text-slate-800">Detalle del env&iacute;o</h4>


        <div class="mt-2 grid grid-cols-1 sm:grid-cols-4 gap-2">


          <div>


            <label class="block text-sm text-slate-700">Cantidad</label>


            <input type="number" min="1" [(ngModel)]="newDet.cantidad"
                   class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


          </div>


          <div class="sm:col-span-2">


            <label class="block text-sm text-slate-700">Descripci&oacute;n</label>


            <input type="text" [(ngModel)]="newDet.descripcion"
                   class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


          </div>


          <div>


            <label class="block text-sm text-slate-700">Precio unitario</label>


            <input type="number" min="0" step="0.01" [(ngModel)]="newDet.precio_unitario"
                   class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


          </div>


        </div>


        <div class="mt-2 flex justify-end">


          <button type="button" (click)="addDetalle()"
                  class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-white/60">Agregar
            &iacute;tem
          </button>


        </div>
        <div *ngIf="detallesLoading" class="mt-3 text-sm text-slate-500">Cargando detalle…</div>


        <div *ngIf="!detallesLoading && stagedDetalles.length" class="mt-3 overflow-x-auto">


          <table class="min-w-full text-sm">


            <thead class="text-left text-slate-600">


            <tr>


              <th class="px-2 py-1">#</th>


              <th class="px-2 py-1">Cantidad</th>


              <th class="px-2 py-1">Descripci&oacute;n</th>


              <th class="px-2 py-1">P. Unitario</th>


              <th class="px-2 py-1">Subtotal</th>


              <th class="px-2 py-1"></th>


            </tr>


            </thead>


            <tbody>


            <tr *ngFor="let d of stagedDetalles; index as i" class="border-t border-slate-200">


              <td class="px-2 py-1">{{ i + 1 }}</td>


              <td class="px-2 py-1">{{ d.cantidad }}</td>


              <td class="px-2 py-1">{{ d.descripcion }}</td>


              <td class="px-2 py-1">{{ d.precio_unitario | number:'1.2-2' }}</td>


              <td class="px-2 py-1">{{ (d.cantidad * d.precio_unitario) | number:'1.2-2' }}</td>


              <td class="px-2 py-1 text-right">


                <button type="button" (click)="removeDetalle(i)"
                        class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Quitar
                </button>


              </td>


            </tr>


            </tbody>


          </table>


          <div class="mt-2 text-right text-sm text-slate-700">Total: {{ stagedSubtotal | number:'1.2-2' }}</div>


        </div>


      </div>


      <div class="mt-6 flex items-center justify-between gap-2">


        <button (click)="closeCreate()"
                class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-white/60">Cancelar
        </button>


        <div class="text-sm text-red-600" *ngIf="saveError">{{ saveError }}</div>


        <button (click)="submitEnvio()" [disabled]="!isValidEnvio || saving"


                class="rounded-md bg-[#21D0B2] px-3 py-2 text-sm font-medium text-white hover:bg-[#21D0B2]/90 disabled:opacity-50">
          Guardar
        </button>


      </div>


    </div>


  </div>


</div>


<div *ngIf="showEdit" class="px-4 mt-4">


  <div class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">


    <h3 class="text-lg font-semibold text-slate-800">Editar env&iacute;o</h3>


    <div class="mt-4 space-y-4">


      <div class="grid grid-cols-2 gap-3">


        <div class="relative" (click)="$event.stopPropagation()">


          <label class="block text-sm text-slate-700">Remitente</label>


          <div class="mt-1 relative">


            <div class="flex items-center gap-2">


              <input type="text" [(ngModel)]="remitenteQuery" (focus)="showRemitenteOptions=true"
                     (input)="showRemitenteOptions=true" placeholder="Buscar envío"
                     class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


              <button type="button" (click)="clearRemitente()"
                      class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Limpiar
              </button>


            </div>


            <div *ngIf="showRemitenteOptions"
                 class="absolute left-0 right-0 top-full z-10 mt-1 max-h-56 w-full overflow-auto rounded-md border border-slate-200 bg-white shadow">


              <div *ngIf="personasLoading" class="px-3 py-2 text-sm text-slate-500">Cargando...</div>


              <div *ngIf="personasError" class="px-3 py-2 text-sm text-red-600">{{ personasError }}</div>


              <button *ngFor="let p of filteredRemitentes" type="button" (click)="selectRemitente(p)"
                      class="block w-full px-3 py-2 text-left text-sm hover:bg-white/60">{{ personaLabel(p) }}
              </button>


              <div *ngIf="!personasLoading && !filteredRemitentes.length" class="px-3 py-2 text-sm text-slate-500">Sin
                resultados
              </div>


            </div>


          </div>


          <div class="mt-2 grid grid-cols-[auto,1fr,auto,auto] items-center gap-2">


            <select [(ngModel)]="remitenteDocType" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm">


              <option [ngValue]="'RUC'">RUC</option>


              <option [ngValue]="'DNI'">DNI</option>


            </select>


            <input type="text" [(ngModel)]="remitenteDocNumber" (keydown.enter)="lookupRemitente()" placeholder="Nro documento"
                   class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


            <button type="button" (click)="lookupRemitente()" [disabled]="remLookupLoading"
                    class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-white/60">{{ remLookupLoading ? 'Buscando...' : 'Buscar' }}
            </button>


          </div>


          <div class="text-xs text-red-600 mt-1" *ngIf="remLookupError">{{ remLookupError }}</div>


        </div>


        <div class="relative" (click)="$event.stopPropagation()">


          <label class="block text-sm text-slate-700">Destinatario</label>


          <div class="mt-1 relative">


            <div class="flex items-center gap-2">


              <input type="text" [(ngModel)]="destinatarioQuery" (focus)="showDestinatarioOptions=true"
                     (input)="showDestinatarioOptions=true" placeholder="Buscar envío"
                     class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


              <button type="button" (click)="clearDestinatario()"
                      class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Limpiar
              </button>


            </div>


            <div *ngIf="showDestinatarioOptions"
                 class="absolute left-0 right-0 top-full z-10 mt-1 max-h-56 w-full overflow-auto rounded-md border border-slate-200 bg-white shadow">


              <div *ngIf="personasLoading" class="px-3 py-2 text-sm text-slate-500">Cargando...</div>


              <div *ngIf="personasError" class="px-3 py-2 text-sm text-red-600">{{ personasError }}</div>


              <button *ngFor="let p of filteredDestinatarios" type="button" (click)="selectDestinatario(p)"
                      class="block w-full px-3 py-2 text-left text-sm hover:bg-white/60">{{ personaLabel(p) }}
              </button>


              <div *ngIf="!personasLoading && !filteredDestinatarios.length" class="px-3 py-2 text-sm text-slate-500">
                Sin resultados
              </div>


            </div>


          </div>


          <div class="mt-2 grid grid-cols-[auto,1fr,auto] items-center gap-2">


            <select [(ngModel)]="destinatarioDocType"
                    class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm">


              <option [ngValue]="'RUC'">RUC</option>


              <option [ngValue]="'DNI'">DNI</option>


            </select>


            <input type="text" [(ngModel)]="destinatarioDocNumber" (keydown.enter)="lookupDestinatario()" placeholder="Nro documento"
                   class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


            <button type="button" (click)="lookupDestinatario()" [disabled]="destLookupLoading"
                    class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-white/60">{{ destLookupLoading ? 'Buscando...' : 'Buscar' }}
            </button>


          </div>


          <div class="text-xs text-red-600 mt-1" *ngIf="destLookupError">{{ destLookupError }}</div>


        </div>


      </div>


      <div class="grid grid-cols-3 gap-3">


        <div>


          <label class="block text-sm text-slate-700">Peso (kg)</label>


          <input type="number" min="0" step="0.01" [(ngModel)]="newEnvio.peso" placeholder="0.00"
                 class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        </div>


        <div>


          <label class="block text-sm text-slate-700">Fecha envío</label>


          <input type="date" [(ngModel)]="newEnvio.fecha_envio"
                 class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        </div>


        <div>


          <label class="block text-sm text-slate-700">Fecha recepci&oacute;n</label>


          <input type="date" [(ngModel)]="newEnvio.fecha_recepcion"
                 class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        </div>


      </div>


      <div class="grid grid-cols-2 gap-3">


        <div>


          <label class="block text-sm text-slate-700">Origen</label>


          <select [(ngModel)]="newEnvio.punto_origen_id"
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]" (ngModelChange)="onOrigenChange($event)">


            <option [ngValue]="null">Seleccione...</option>


            <option *ngFor="let p of puntos" [ngValue]="p.id" [disabled]="p.id === newEnvio.punto_destino_id">{{ p.nombre }}</option>


          </select>


          <div class="text-xs text-slate-500 mt-1" *ngIf="puntosLoading">Cargando puntos...</div>


          <div class="text-xs text-red-600 mt-1" *ngIf="puntosError">{{ puntosError }}</div>


        </div>


        <div>


          <label class="block text-sm text-slate-700">Destino</label>


          <select [(ngModel)]="newEnvio.punto_destino_id"
                  class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]" (ngModelChange)="onDestinoChange($event)">


            <option [ngValue]="null">Seleccione...</option>


            <option *ngFor="let p of puntos" [ngValue]="p.id" [disabled]="p.id === newEnvio.punto_origen_id">{{ p.nombre }}</option>


          </select>


        </div>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Clave de recojo</label>


        <input type="text" [(ngModel)]="newEnvio.clave_recojo" placeholder="CLV-XXXX"
               class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


      </div>


      <div class="grid grid-cols-2 gap-3">


        <label class="inline-flex items-center gap-2 text-sm text-slate-700">


          <input type="checkbox" [(ngModel)]="newEnvio.estado_pago" class="h-4 w-4 accent-[#2F455C]"/>


          Pagado


        </label>


        <label class="inline-flex items-center gap-2 text-sm text-slate-700">


          <input type="checkbox" [(ngModel)]="newEnvio.tipo_contenido" class="h-4 w-4 accent-[#2F455C]"/>


          Contenido especial


        </label>


      </div>

      <div class="grid grid-cols-2 gap-3 mt-2">
        <label class="inline-flex items-center gap-2 text-sm text-slate-700">
          <input type="checkbox" [(ngModel)]="sendWhatsapp" class="h-4 w-4 accent-[#2F455C]"/>
          Enviar WhatsApp
        </label>
        <div *ngIf="sendWhatsapp">
          <input type="text" [(ngModel)]="whatsappPhone" placeholder="Celular (sin +51)"/>
        </div>
      </div>
      <div class="mt-6">
        <h4 class="text-sm font-medium text-slate-800">Detalle del env&iacute;o</h4>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-4 gap-2">
          <div>
            <label class="block text-sm text-slate-700">Cantidad</label>
            <input type="number" min="1" [(ngModel)]="newDet.cantidad"
                   class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm text-slate-700">Descripci&oacute;n</label>
            <input type="text" [(ngModel)]="newDet.descripcion"
                   class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
          </div>
          <div>
            <label class="block text-sm text-slate-700">Precio unitario</label>
            <input type="number" min="0" step="0.01" [(ngModel)]="newDet.precio_unitario"
                   class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>
          </div>
        </div>
        <div class="mt-2 flex justify-end">
          <button type="button" (click)="addDetalle()"
                  class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-white/60">Agregar &iacute;tem</button>
        </div>
        <div *ngIf="detallesLoading" class="mt-3 text-sm text-slate-500">Cargando detalle…</div>
        <div>{{ stagedDetalles.length }}</div>
        <div *ngIf="!detallesLoading && stagedDetalles.length" class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr>
                <th class="px-2 py-1">#</th>
                <th class="px-2 py-1">Cantidad</th>
                <th class="px-2 py-1">Descripci&oacute;n</th>
                <th class="px-2 py-1">P. Unitario</th>
                <th class="px-2 py-1">Subtotal</th>
                <th class="px-2 py-1"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let d of stagedDetalles; index as i" class="border-t border-slate-200">
                <td class="px-2 py-1">{{ i + 1 }}</td>
                <td class="px-2 py-1">{{ d.cantidad }}</td>
                <td class="px-2 py-1">{{ d.descripcion }}</td>
                <td class="px-2 py-1">{{ d.precio_unitario | number:'1.2-2' }}</td>
                <td class="px-2 py-1">{{ (d.cantidad * d.precio_unitario) | number:'1.2-2' }}</td>
                <td class="px-2 py-1 text-right">
                  <button type="button" (click)="removeDetalle(i)"
                          class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Quitar</button>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="mt-2 text-right text-sm text-slate-700">Total: {{ stagedSubtotal | number:'1.2-2' }}</div>
        </div>
      </div>



      <div class="mt-6 flex items-center justify-between gap-2">


        <button (click)="closeEdit()"
                class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-white/60">Cancelar
        </button>


        <div class="text-sm text-red-600" *ngIf="saveError">{{ saveError }}</div>


        <button (click)="submitEnvio()" [disabled]="!isValidEnvio || saving"


                class="rounded-md bg-[#21D0B2] px-3 py-2 text-sm font-medium text-white hover:bg-[#21D0B2]/90 disabled:opacity-50">
          Guardar
        </button>


      </div>


    </div>


  </div>


</div>


<ui-confirm [show]="confirmOpen" [title]="confirmTitle" [message]="confirmMessage" [confirmText]="'Eliminar'"
            [type]="'danger'" (confirm)="onConfirmDelete()" (cancel)="onCancelDelete()"></ui-confirm>


<div *ngIf="compInlineForEntrega" class="px-4 mt-4">


  <div
    class="rounded-md border border-[#26A69A] bg-[#26A69A]/10 ring-1 ring-[#26A69A]/20 p-4 shadow-sm border-l-4 border-l-[#26A69A]">


    <div class="text-sm font-semibold text-[#0A1A2F] mb-2">Comprobante para env&iacute;o {{ compEnvioId }}</div>


    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">


      <div>


        <label class="block text-sm text-slate-700">Tipo</label>


        <select [(ngModel)]="compTipoSel" (ngModelChange)="onCompTipoChange($event)"
                class="mt-1 w-full rounded-md border border-slate-300 px-2 py-2 text-sm">


          <option [ngValue]="null">Seleccione...</option>


          <option *ngFor="let t of compTipos" [ngValue]="t">{{ t.nombre }}</option>


        </select>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Serie</label>


        <input type="text" [value]="compSerie" readonly
               class="mt-1 w-full rounded-md border border-slate-300 bg-white/60 px-2 py-2 text-sm"/>


      </div>


      <div>


        <label class="block text-sm text-slate-700">N&uacute;mero</label>


        <input type="text" [value]="compNumeroComprobante" readonly
               class="mt-1 w-full rounded-md border border-slate-300 bg-white/60 px-2 py-2 text-sm"/>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Forma de pago</label>


        <select [(ngModel)]="compFormaPagoId" class="mt-1 w-full rounded-md border border-slate-300 px-2 py-2 text-sm">


          <option [ngValue]="null">Seleccione...</option>


          <option *ngFor="let p of payTipos" [ngValue]="p.id">{{ p.nombre }}</option>


        </select>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Fecha pago</label>


        <input type="date" [(ngModel)]="compFechaPago"
               class="mt-1 w-full rounded-md border border-slate-300 px-2 py-2 text-sm"/>


      </div>


      <div class="sm:col-span-3"></div>


    </div>


    <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">


      <div class="sm:col-span-2">


        <label class="block text-sm text-slate-700">Cliente ({{ compDocType }})</label>


        <div class="mt-1 grid grid-cols-[auto,1fr,auto] items-center gap-2">


          <select [(ngModel)]="compDocType" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm">


            <option [ngValue]="'DNI'">DNI</option>


            <option [ngValue]="'RUC'">RUC</option>


          </select>


          <input type="text" [(ngModel)]="compDocNumber" placeholder="Documento"
                 class="h-9 w-full rounded-md border border-slate-300 px-3 text-sm"/>


          <button type="button" (click)="lookupCliente()" [disabled]="compLookupLoading"
                  class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">{{ compLookupLoading ? 'Buscando...' : 'Buscar' }}
          </button>


        </div>


        <span *ngIf="compClienteId"
              class="text-xs text-slate-600 pl-1 truncate max-w-[14rem]">{{ compClienteLabel() }}</span>


        <div class="text-xs text-red-600 mt-1" *ngIf="compLookupError">{{ compLookupError }}</div>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Impuesto</label>


        <input type="text" [value]="compImpuesto | number:'1.2-2'" readonly
               class="mt-1 w-full rounded-md border border-slate-300 bg-white/60 px-2 py-2 text-sm"/>


      </div>


    </div>


    <!-- Detalle del envï¿½o (solo lectura) -->
  <div *ngIf="detallesLoading" class="mt-3 text-sm text-slate-500">Cargando detalle…</div>
    <div *ngIf="!detallesLoading && stagedDetalles.length" class="mt-3 overflow-x-auto">
      <h4 class="text-sm font-medium text-slate-800 mb-1">Detalle del env&iacute;o</h4>
      <table class="min-w-full text-sm">
        <thead class="text-left text-slate-600">
          <tr>
            <th class="px-2 py-1">#</th>
            <th class="px-2 py-1">Cantidad</th>
            <th class="px-2 py-1">Descripci&oacute;n</th>
            <th class="px-2 py-1">P. Unitario</th>
            <th class="px-2 py-1">Subtotal</th>
          </tr>
        </thead>
        <tbody class="text-slate-800">
          <tr *ngFor="let d of stagedDetalles; index as i" class="border-t border-slate-100">
            <td class="px-2 py-1">{{ i + 1 }}</td>
            <td class="px-2 py-1">{{ d.cantidad }}</td>
            <td class="px-2 py-1">{{ d.descripcion }}</td>
            <td class="px-2 py-1">{{ d.precio_unitario | number:'1.2-2' }}</td>
            <td class="px-2 py-1">{{ (d.cantidad * d.precio_unitario) | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div *ngIf="!detallesLoading && !stagedDetalles.length" class="mt-3 rounded-md border border-dashed border-slate-300 bg-white px-3 py-3 text-sm text-slate-500">
      Sin &iacute;tems para facturar.
    </div>
    <div class="mt-2 text-right text-sm text-slate-700">Total: {{ compTotal | number:'1.2-2' }}</div>


    <div class="mt-1 text-right text-sm text-slate-700" *ngIf="compTipoNombre().toLowerCase().includes('fact')">Total
      (con impuesto): {{ compTotalConImpuesto | number:'1.2-2' }}
    </div>


    <div class="mt-4 flex items-center justify-end gap-2">


      <button type="button" (click)="compInlineForEntrega=false; compEnvioId=null"
              class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">Cancelar
      </button>


      <button type="button" [disabled]="!compValid" (click)="submitComprobanteEntrega()"
              class="rounded-md bg-[#26A69A] px-3 py-2 text-sm font-medium text-white disabled:opacity-50">Generar
        comprobante
      </button>


    </div>


  </div>


</div>
<section class="px-4 pb-2" *ngIf="!loading && !error; else stateTpl">


  <ng-container *ngIf="pageItems?.length; else empty">


    <div *ngIf="viewMode=='cards'" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">


      <div *ngFor="let item of pageItems; index as i"
           class="group rounded-lg border border-slate-200 bg-white p-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">


        <div class="mb-3 flex items-start justify-between">


          <div class="min-w-0">


            <div class="font-medium text-slate-800 truncate max-w-[14rem]">Envío: {{ item.id || '-' }}</div>


            <div class="text-xs text-slate-500">ID: {{ i + 1 + (page - 1) * pageSize }}</div>


          </div>


        </div>


        <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-600">


          <span
            class="inline-block rounded border border-blue-200 bg-blue-50 text-blue-700 px-2 py-0.5">Remitente: {{ personaLabelById(item.remitente) || item.remitente }}</span>


          <span class="inline-block rounded border border-indigo-200 bg-indigo-50 text-indigo-700 px-2 py-0.5">Destinatario: {{ personaLabelById(item.destinatario) || item.destinatario }}</span>


          <span class="inline-block rounded bg-slate-100 px-2 py-0.5">Peso: {{ item.peso }}</span>


          <span class="inline-block rounded bg-slate-100 px-2 py-0.5">Fecha envío</span>


          <span
            class="inline-block rounded bg-slate-100 px-2 py-0.5">Origen: {{ getPuntoNombre(item.punto_origen_id) }}</span>


          <span
            class="inline-block rounded bg-slate-100 px-2 py-0.5">Destino: {{ getPuntoNombre(item.punto_destino_id) }}</span>


          <span class="inline-block rounded border border-emerald-200 bg-emerald-50 text-emerald-700 px-2 py-0.5"
                *ngIf="item.estado_pago">Pagado</span>


          <span class="inline-block rounded border border-red-200 bg-red-50 text-red-700 px-2 py-0.5"
                *ngIf="!item.estado_pago">No pagado</span>


        </div>


        <div class="mt-4 flex items-center justify-end gap-2 flex-wrap">


          <span *ngIf="item.fecha_recepcion"
                class="rounded-md border border-red-200 bg-red-300 px-2.5 py-1.5 text-xs text-red-900 hover:bg-primary/20">Entregado <i
            class=""></i></span>


          <button type="button" *ngIf="!item.fecha_recepcion"
                  class="rounded-md border border-emerald-200 bg-emerald-50 px-2.5 py-1.5 text-xs text-emerald-700 hover:bg-emerald-100"
                  (click)="openEntrega(item); $event.stopPropagation()">Entregar
          </button>
          <button type="button"
                  class="rounded-md border border-slate-200 px-2.5 py-1.5 text-xs text-slate-700 hover:bg-white/60"
                  (click)="openEdit(item)">
            <ng-icon name="heroPencil" size="16"></ng-icon>
            <span class="sr-only">Editar</span></button>


          <button type="button"
                  class="rounded-md border border-primary/20 bg-primary/10 px-2.5 py-1.5 text-xs text-primary hover:bg-primary/20"
                  (click)="askDelete(item)">
            <ng-icon name="heroNoSymbol" size="16"></ng-icon>
            <span class="sr-only">Eliminar</span></button>


        </div>


      </div>


    </div>


    <div *ngIf="viewMode==='table'" class="mt-4 overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 bg-white rounded-md border border-slate-200">
        <thead class="bg-white/60 text-slate-700 text-sm">
        <tr>
          <th class="px-3 py-2 text-left">Gu&iacute;a</th>
          <th class="px-3 py-2 text-left">Remitente</th>
          <th class="px-3 py-2 text-left">Destinatario</th>
          <th class="px-3 py-2 text-left">Peso</th>
          <th class="px-3 py-2 text-left">Fecha envío</th>
          <th class="px-3 py-2 text-left">Origen</th>
          <th class="px-3 py-2 text-left">Destino</th>
          <th class="px-3 py-2 text-right">Acciones</th>
        </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-sm text-slate-800">
        <tr *ngFor="let item of pageItems">
          <td class="px-3 py-2">{{ item.id || '-' }}</td>
          <td class="px-3 py-2">{{ personaLabelById(item.remitente) || item.remitente }}</td>
          <td class="px-3 py-2">{{ personaLabelById(item.destinatario) || item.destinatario }}</td>
          <td class="px-3 py-2">{{ item.peso }}</td>
          <td class="px-3 py-2">{{ item.fecha_envio | ymd }}</td>
          <td class="px-3 py-2">{{ getPuntoNombre(item.punto_origen_id) }}</td>
          <td class="px-3 py-2">{{ getPuntoNombre(item.punto_destino_id) }}</td>
          <td class="px-3 py-2 text-right">
            <button type="button" *ngIf="!item.fecha_recepcion"
                    class="rounded-md border border-emerald-200 bg-emerald-50 px-2.5 py-1.5 text-xs text-emerald-800 hover:bg-emerald-100"
                    (click)="openEntrega(item)">Confirmar entrega
            </button>
            <button type="button"
                    class="rounded-md border border-slate-200 bg-white px-2.5 py-1.5 text-xs text-slate-700 hover:bg-white/60"
                    (click)="openEdit(item)">
              <ng-icon name="heroPencil" size="16"></ng-icon>
              <span class="sr-only">Editar</span></button>
            <button type="button"
                    class="rounded-md border border-primary/20 bg-primary/10 px-2.5 py-1.5 text-xs text-primary hover:bg-primary/20"
                    (click)="askDelete(item)">
              <ng-icon name="heroNoSymbol" size="16"></ng-icon>
              <span class="sr-only">Eliminar</span></button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>


    <div class="mt-6 flex items-center justify-between text-sm text-slate-600">


      <div>


        Mostrando {{ pageStart }}-{{ pageEnd }} de {{ total }} envíos
      </div>


      <div class="flex items-center gap-2">


        <button (click)="setPage(page-1)" [disabled]="page===1"


                class="rounded-md border border-slate-200 bg-white px-2.5 py-1.5 hover:bg-white/60 disabled:opacity-50">
          Anterior
        </button>


        <span>Página {{ page }} / {{ totalPages }}</span>


        <button (click)="setPage(page+1)" [disabled]="page===totalPages"


                class="rounded-md border border-slate-200 bg-white px-2.5 py-1.5 hover:bg-white/60 disabled:opacity-50">
          Siguiente
        </button>


      </div>


    </div>


  </ng-container>


  <ng-template #empty>


    <div
      class="flex items-center justify-center rounded-md border border-dashed border-slate-300 bg-white py-16 text-slate-500">


      No hay envíos para mostrar.


    </div>


  </ng-template>


</section>


<ng-template #stateTpl>


  <div class="px-6 pb-6">


    <div *ngIf="loading" class="rounded-md border border-slate-200 bg-white p-6 text-slate-600">Cargando...</div>


    <div *ngIf="error" class="rounded-md border border-red-200 bg-red-50 p-6 text-red-700">{{ error }}</div>


  </div>


</ng-template>


<!-- Overlay template for entrega (CDK) -->


<!-- Ticket Modal -->


<div *ngIf="showTicket" class="fixed inset-0 z-50 flex items-center justify-center">


  <div class="absolute inset-0 bg-black/30" (click)="closeTicket()"></div>


  <div class="relative z-10 w-[86mm] max-w-[86mm] rounded-md bg-white p-4 shadow-xl">


    <div class="flex items-center justify-between ticket-actions">


      <h3 class="text-sm font-semibold text-slate-800">Ticket de env&iacute;o</h3>


      <div class="flex gap-2">


        <button (click)="printTicket()"
                class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Imprimir
        </button>


        <button (click)="closeTicket()"
                class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-white/60">Cerrar
        </button>


      </div>


    </div>


    <div class="mt-2 ticket w-[80mm] max-w-[80mm] text-[12px] text-slate-800">


      <div class="text-center">


        <div class="font-semibold">ENV&Iacute;O</div>


        <div class="text-xs text-slate-600">ID: {{ ticketEnvio?.id }}</div>


      </div>


      <div class="mt-2">


        <div class="mt-2">


          <div><span
            class="font-medium">Remitente:</span> {{ personaLabelById(ticketEnvio?.remitente) || ticketEnvio?.remitente }}
          </div>


          <div><span
            class="font-medium">Destinatario:</span> {{ personaLabelById(ticketEnvio?.destinatario) || ticketEnvio?.destinatario }}
          </div>


          <div><span class="font-medium">Origen:</span> {{ getPuntoNombre(ticketEnvio?.punto_origen_id) }}</div>


          <div><span class="font-medium">Destino:</span> {{ getPuntoNombre(ticketEnvio?.punto_destino_id) }}</div>


          <div><span class="font-medium">Fecha envío</span> {{ (ticketEnvio?.fecha_envio ?? '') | ymd }}</div>


          <div><span class="font-medium">Clave:</span> {{ ticketEnvio?.clave_recojo }}</div>


        </div>


      </div>


      <div class="mt-2 border-t border-dashed border-slate-300"></div>


      <div class="mt-2">


        <div class="font-medium">Detalle</div>


        <table class="mt-1 w-full">


          <thead class="text-left text-[11px] text-slate-600">


          <tr>


            <th class="pr-2">#</th>


            <th class="pr-2">Cant</th>


            <th class="pr-2">Desc</th>


            <th class="pr-2 text-right">P.Unit</th>


            <th class="text-right">Subt</th>


          </tr>


          </thead>


          <tbody class="text-[12px]">


          <tr *ngFor="let d of ticketDetalles" class="align-top">


            <td class="pr-2">{{ d.numero_item }}</td>


            <td class="pr-2">{{ d.cantidad }}</td>


            <td class="pr-2">{{ d.descripcion }}</td>


            <td class="pr-2 text-right">{{ d.precio_unitario | number:'1.2-2' }}</td>


            <td class="text-right">{{ (d.cantidad * d.precio_unitario) | number:'1.2-2' }}</td>


          </tr>


          </tbody>


        </table>


        <div class="mt-1 text-right text-[12px]">Total: {{ ticketTotal | number:'1.2-2' }}</div>


      </div>


      <div class="mt-3 flex items-center justify-center">


        <img *ngIf="ticketEnvio?.id"
             [src]="'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + ticketEnvio?.id"
             class="h-32 w-32" alt="QR"/>


      </div>


      <div class="mt-1 text-center text-[11px] text-slate-500">Gracias por su preferencia</div>


    </div>


  </div>


</div>


<ng-template cdkPortal #entregaTpl>


  <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-xl">


    <h3 class="text-lg font-semibold text-slate-800">Confirmar entrega</h3>


    <div class="mt-4 space-y-4" *ngIf="entregaItem as it">


      <div class="text-sm text-slate-700 space-y-1">


        <div>Gu&iacute;a: <span class="font-medium">{{ it.id || '-' }}</span></div>


        <div>Remitente: <span class="font-medium">{{ personaLabelById(it.remitente) || it.remitente }}</span></div>


        <div>Destinatario: <span class="font-medium">{{ personaLabelById(it.destinatario) || it.destinatario }}</span>
        </div>


        <div class="flex items-center gap-2">Pagado:


          <span class="inline-block rounded border border-emerald-200 bg-emerald-50 text-emerald-700 px-2 py-0.5"
                *ngIf="it.estado_pago">S&iacute;</span>


          <span class="inline-block rounded border border-red-200 bg-red-50 text-red-700 px-2 py-0.5"
                *ngIf="!it.estado_pago">No</span>


        </div>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Clave de recojo</label>


        <input type="password" [(ngModel)]="entregaClaveInput" placeholder="Ingrese la clave de recojo"
               class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        <div class="mt-1 text-xs" [class.text-emerald-700]="entregaClaveOk"
             [class.text-red-600]="!entregaClaveOk && entregaClaveInput">


          {{ entregaClaveInput ? (entregaClaveOk ? 'Clave v&aacute;lida' : 'Clave incorrecta') : 'Ingrese la clave para validar' }}


        </div>


      </div>


      <div>


        <label class="block text-sm text-slate-700">Fecha de recepci&oacute;n</label>


        <input type="date" [(ngModel)]="entregaFecha"
               class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-[#26A69A] focus:outline-none focus:ring-1 focus:ring-[#26A69A]"/>


        <div class="mt-1 text-xs text-slate-500">Se registrarán.</div>


      </div>


      <div class="text-sm text-red-600" *ngIf="entregaError">{{ entregaError }}</div>


    </div>


    <div class="mt-6 flex items-center justify-between gap-2">


      <button type="button" (click)="closeEntrega()"
              class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-white/60">Cancelar
      </button>


      <button type="button" (click)="submitEntrega()" [disabled]="!entregaClaveOk || entregaSaving"


              class="rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-700 disabled:opacity-50">
        Confirmar entrega
      </button>


    </div>


  </div>


</ng-template>






























































