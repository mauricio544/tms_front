<div class="p-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">Reportes</h1>
      <p class="mt-1 text-slate-600">Resumen de KPIs y movimientos</p>
    </div>
    <div class="flex items-center gap-2">
      <button (click)="load()" class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">Refrescar</button>
    </div>
  </div>
</div>

<div class="px-6 pb-6">
  <div *ngIf="loading" class="rounded-md border border-slate-200 bg-white p-6 text-slate-600">Cargando.</div>
  <div *ngIf="error" class="rounded-md border border-red-200 bg-red-50 p-6 text-red-700">{{ error }}</div>

  <!-- Filtros + acciones -->
  <div *ngIf="!loading && !error" class="mt-2 flex flex-wrap items-end gap-3">
    <div class="flex items-center gap-2">
      <label class="text-sm text-slate-600">Desde</label>
      <input type="date" [(ngModel)]="fromDate" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm" (ngModelChange)="onDateChange()">
    </div>
    <div class="flex items-center gap-2">
      <label class="text-sm text-slate-600">Hasta</label>
      <input type="date" [(ngModel)]="toDate" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm" (ngModelChange)="onDateChange()">
    </div>
    <div class="ml-auto flex items-center gap-2">
      <button (click)="exportCSV()" class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">Exportar CSV</button>
      <button (click)="exportPDF()" class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">Exportar PDF</button>
    </div>
  </div>

  <!-- KPIs envíos -->
  <div *ngIf="!loading && !error" class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Envíos entregados</div>
      <div class="mt-1 text-2xl font-semibold text-slate-800">{{ kpiEntregados | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Envíos no entregados</div>
      <div class="mt-1 text-2xl font-semibold text-slate-800">{{ kpiNoEntregados | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Pagados</div>
      <div class="mt-1 text-2xl font-semibold text-emerald-700">{{ kpiPagados | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">No pagados</div>
      <div class="mt-1 text-2xl font-semibold text-red-700">{{ kpiNoPagados | number }}</div>
    </div>
  </div>

  <!-- Resumen movimientos -->
  <div *ngIf="!loading && !error" class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-3">
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Ingresos</div>
      <div class="mt-1 text-2xl font-semibold text-emerald-700">{{ totalIngresos | number:'1.2-2' }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Egresos</div>
      <div class="mt-1 text-2xl font-semibold text-red-700">-{{ totalEgresos | number:'1.2-2' }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Neto</div>
      <div class="mt-1 text-2xl font-semibold" [ngClass]="{ 'text-emerald-700': totalNeto >= 0, 'text-red-700': totalNeto < 0 }">{{ totalNeto | number:'1.2-2' }}</div>
    </div>
  </div>

  <!-- Gr�ficas simples -->
  <div *ngIf="!loading && !error" class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
    <!-- Pie pagados/no pagados -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Distribución: Pagados / No pagados</div>
      <div class="flex items-center gap-4">
        <div class="h-32 w-32 rounded-full" [style.background]="'conic-gradient(#059669 0 '+piePagadosDeg+'deg, #ef4444 '+piePagadosDeg+'deg 360deg)'" title="Pie pagados/no pagados"></div>
        <div class="text-sm text-slate-700">
          <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-emerald-600"></span> Pagados: <strong>{{ kpiPagados }}</strong></div>
          <div class="mt-1 flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-red-500"></span> No pagados: <strong>{{ kpiNoPagados }}</strong></div>
          <div class="mt-1 text-xs text-slate-500">Total: {{ totalEnvios }}</div>
        </div>
      </div>
    </div>

    <!-- Barras ingresos/egresos -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Ingresos vs. Egresos</div>
      <div class="space-y-3">
        <div>
          <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span>Ingresos</span><span>{{ totalIngresos | number:'1.2-2' }}</span></div>
          <div class="h-3 w-full rounded bg-slate-100">
            <div class="h-3 rounded bg-emerald-600" [style.width]="(totalIngresos / movMax * 100) + '%'"></div>
          </div>
        </div>
        <div>
          <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span>Egresos</span><span>{{ totalEgresos | number:'1.2-2' }}</span></div>
          <div class="h-3 w-full rounded bg-slate-100">
            <div class="h-3 rounded bg-red-500" [style.width]="(totalEgresos / movMax * 100) + '%'"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Origen -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Top 5 Origen</div>
      <div *ngIf="!topOrigen.length" class="text-sm text-slate-500">Sin datos</div>
      <div *ngFor="let it of topOrigen" class="mb-2 last:mb-0">
        <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span class="truncate pr-2">{{ it.label }}</span><span>{{ it.value }}</span></div>
        <div class="h-2 w-full rounded bg-slate-100"><div class="h-2 rounded bg-slate-400" [style.width]="(it.value / (topOrigen[0]?.value || 1) * 100) + '%' "></div></div>
      </div>
    </div>

    <!-- Top Destino -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Top 5 Destino</div>
      <div *ngIf="!topDestino.length" class="text-sm text-slate-500">Sin datos</div>
      <div *ngFor="let it of topDestino" class="mb-2 last:mb-0">
        <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span class="truncate pr-2">{{ it.label }}</span><span>{{ it.value }}</span></div>
        <div class="h-2 w-full rounded bg-slate-100"><div class="h-2 rounded bg-slate-400" [style.width]="(it.value / (topDestino[0]?.value || 1) * 100) + '%' "></div></div>
      </div>
    </div>

    <!-- Top Cliente (destinatario) -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Top 5 Clientes</div>
      <div *ngIf="!topCliente.length" class="text-sm text-slate-500">Sin datos</div>
      <div *ngFor="let it of topCliente" class="mb-2 last:mb-0">
        <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span class="truncate pr-2">{{ it.label }}</span><span>{{ it.value }}</span></div>
        <div class="h-2 w-full rounded bg-slate-100"><div class="h-2 rounded bg-slate-400" [style.width]="(it.value / (topCliente[0]?.value || 1) * 100) + '%' "></div></div>
      </div>
    </div>
  </div>
</div>
<!-- Mapa: Or�genes y Destinos (Top 5) -->
<div *ngIf="!loading && !error" class="mt-6">
  <div class="rounded-lg border border-slate-200 bg-white p-4">
    <div class="mb-2 flex items-center justify-between">
      <div class="text-sm font-medium text-slate-800">Mapa de or�genes y destinos (Top 5)</div>
      <div class="text-xs text-slate-500" *ngIf="hasCoords; else noCoords">Arrastra para mover, usa el control +/- o el scroll para zoom</div>
      <ng-template #noCoords><span class="text-xs text-slate-500">No hay coordenadas en los Puntos</span></ng-template>
    </div>
    <div class="relative">
      <div id="reportesMap" class="h-80 w-full rounded border border-slate-200"></div>
      <div class="pointer-events-none absolute bottom-2 right-2 rounded bg-white/70 px-1.5 py-0.5 text-[10px] text-slate-600">? Origen (verde) � ? Destino (�ndigo)
    </div>
  </div>
</div>
