<div class="p-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">Reportes</h1>
      <p class="mt-1 text-slate-600">Resumen de KPIs y movimientos</p>
    </div>
    <div class="flex items-center gap-2">
      <button (click)="load()" class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">Refrescar</button>
    </div>
  </div>
</div>

<div class="px-6 pb-6">
  <div *ngIf="loading" class="rounded-md border border-slate-200 bg-white p-6 text-slate-600">Cargando.</div>
  <div *ngIf="error" class="rounded-md border border-red-200 bg-red-50 p-6 text-red-700">{{ error }}</div>

  <!-- Filtros + acciones -->
  <div *ngIf="!loading && !error" class="mt-2 flex flex-wrap items-end gap-3">
    <div class="flex items-center gap-2">
      <label class="text-sm text-slate-600">Desde</label>
      <input type="date" [(ngModel)]="fromDate" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary " (ngModelChange)="onDateChange()">
    </div>
    <div class="flex items-center gap-2">
      <label class="text-sm text-slate-600">Hasta</label>
      <input type="date" [(ngModel)]="toDate" class="h-9 rounded-md border border-slate-300 bg-white px-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary " (ngModelChange)="onDateChange()">
    </div>
    <div class="ml-auto flex items-center gap-2">
      <button (click)="exportCSV()" class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">Exportar CSV</button>
      <button (click)="exportPDF()" class="h-9 rounded-md border border-slate-200 bg-white px-3 text-sm hover:bg-slate-50">Exportar PDF</button>
    </div>
  </div>

  <!-- Tabs -->
  <div *ngIf="!loading && !error" class="mt-4 inline-flex overflow-hidden rounded-md border border-slate-200 bg-white text-sm">
    <button (click)="activeTab='kpis'" [class.bg-slate-100]="activeTab==='kpis'" class="px-3 py-2 text-slate-700">KPIs</button>
    <button (click)="activeTab='resumen'" [class.bg-slate-100]="activeTab==='resumen'" class="border-l border-slate-200 px-3 py-2 text-slate-700">Envíos vs Pagos</button>
    <button (click)="activeTab='manifiestos'" [class.bg-slate-100]="activeTab==='manifiestos'" class="border-l border-slate-200 px-3 py-2 text-slate-700">Manifiestos</button>
    <button (click)="activeTab='detracciones'" [class.bg-slate-100]="activeTab==='detracciones'" class="border-l border-slate-200 px-3 py-2 text-slate-700">Detracciones</button>
  </div>

  <!-- KPIs envíos -->
  <div *ngIf="!loading && !error && activeTab==='kpis'" class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Envíos entregados</div>
      <div class="mt-1 text-2xl font-semibold text-slate-800">{{ kpiEntregados | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Envíos no entregados</div>
      <div class="mt-1 text-2xl font-semibold text-slate-800">{{ kpiNoEntregados | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Pagados</div>
      <div class="mt-1 text-2xl font-semibold text-emerald-700">{{ kpiPagados | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">No pagados</div>
      <div class="mt-1 text-2xl font-semibold text-red-700">{{ kpiNoPagados | number }}</div>
    </div>
  </div>

  <!-- KPIs manifiestos -->
  <div *ngIf="!loading && !error && activeTab==='kpis'" class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Manifiestos (total)</div>
      <div class="mt-1 text-2xl font-semibold text-slate-800">{{ totalManifiestos | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Con guía generada</div>
      <div class="mt-1 text-2xl font-semibold text-emerald-700">{{ manifiestosConGuia | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Sin guía</div>
      <div class="mt-1 text-2xl font-semibold text-red-700">{{ manifiestosSinGuia | number }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Estado de guías</div>
      <div class="mt-2 space-y-1 text-sm text-slate-700">
        <div *ngFor="let st of guiaEstadoCounts" class="flex items-center justify-between">
          <span>{{ st.label }}</span>
          <span class="font-semibold">{{ st.value }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Resumen movimientos -->
  <div *ngIf="!loading && !error && activeTab==='kpis'" class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-3">
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Ingresos</div>
      <div class="mt-1 text-2xl font-semibold text-emerald-700">{{ totalIngresos | number:'1.2-2' }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Egresos</div>
      <div class="mt-1 text-2xl font-semibold text-red-700">-{{ totalEgresos | number:'1.2-2' }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="text-xs text-slate-600">Neto</div>
      <div class="mt-1 text-2xl font-semibold" [ngClass]="{ 'text-emerald-700': totalNeto >= 0, 'text-red-700': totalNeto < 0 }">{{ totalNeto | number:'1.2-2' }}</div>
    </div>
  </div>

  <!-- Gráficas simples -->
  <div *ngIf="!loading && !error && activeTab==='kpis'" class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
    <!-- Pie pagados/no pagados -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Distribución: Pagados / No pagados</div>
      <div class="flex items-center gap-4">
        <div class="h-32 w-32 rounded-full" [style.background]="'conic-gradient(#059669 0 '+piePagadosDeg+'deg, #ef4444 '+piePagadosDeg+'deg 360deg)'" title="Pie pagados/no pagados"></div>
        <div class="text-sm text-slate-700">
          <div class="flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-emerald-600"></span> Pagados: <strong>{{ kpiPagados }}</strong></div>
          <div class="mt-1 flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-sm bg-red-500"></span> No pagados: <strong>{{ kpiNoPagados }}</strong></div>
          <div class="mt-1 text-xs text-slate-500">Total: {{ totalEnvios }}</div>
        </div>
      </div>
    </div>

    <!-- Barras ingresos/egresos -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Ingresos vs. Egresos</div>
      <div class="space-y-3">
        <div>
          <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span>Ingresos</span><span>{{ totalIngresos | number:'1.2-2' }}</span></div>
          <div class="h-3 w-full rounded bg-slate-100">
            <div class="h-3 rounded bg-emerald-600" [style.width]="(totalIngresos / movMax * 100) + '%'"></div>
          </div>
        </div>
        <div>
          <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span>Egresos</span><span>{{ totalEgresos | number:'1.2-2' }}</span></div>
          <div class="h-3 w-full rounded bg-slate-100">
            <div class="h-3 rounded bg-red-500" [style.width]="(totalEgresos / movMax * 100) + '%'"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Origen -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Top 5 Origen</div>
      <div *ngIf="!topOrigen.length" class="text-sm text-slate-500">Sin datos</div>
      <div *ngFor="let it of topOrigen" class="mb-2 last:mb-0">
        <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span class="truncate pr-2">{{ it.label }}</span><span>{{ it.value }}</span></div>
        <div class="h-2 w-full rounded bg-slate-100"><div class="h-2 rounded bg-slate-400" [style.width]="(it.value / (topOrigen[0]?.value || 1) * 100) + '%' "></div></div>
      </div>
    </div>

    <!-- Top Destino -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Top 5 Destino</div>
      <div *ngIf="!topDestino.length" class="text-sm text-slate-500">Sin datos</div>
      <div *ngFor="let it of topDestino" class="mb-2 last:mb-0">
        <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span class="truncate pr-2">{{ it.label }}</span><span>{{ it.value }}</span></div>
        <div class="h-2 w-full rounded bg-slate-100"><div class="h-2 rounded bg-slate-400" [style.width]="(it.value / (topDestino[0]?.value || 1) * 100) + '%' "></div></div>
      </div>
    </div>

    <!-- Top Cliente (destinatario) -->
    <div class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 text-sm font-medium text-slate-800">Top 5 Clientes</div>
      <div *ngIf="!topCliente.length" class="text-sm text-slate-500">Sin datos</div>
      <div *ngFor="let it of topCliente" class="mb-2 last:mb-0">
        <div class="mb-1 flex items-center justify-between text-xs text-slate-600"><span class="truncate pr-2">{{ it.label }}</span><span>{{ it.value }}</span></div>
        <div class="h-2 w-full rounded bg-slate-100"><div class="h-2 rounded bg-slate-400" [style.width]="(it.value / (topCliente[0]?.value || 1) * 100) + '%' "></div></div>
      </div>
    </div>
  </div>
</div>
<!-- Mapa: Orígenes y Destinos (Top 5) -->
<div *ngIf="!loading && !error && activeTab==='kpis'" class="mt-6">
  <div class="rounded-lg border border-slate-200 bg-white p-4">
    <div class="mb-2 flex items-center justify-between">
      <div class="text-sm font-medium text-slate-800">Mapa de orígenes y destinos (Top 5)</div>
      <div class="text-xs text-slate-500" *ngIf="hasCoords; else noCoords">Arrastra para mover, usa el control +/- o el scroll para zoom</div>
      <ng-template #noCoords><span class="text-xs text-slate-500">No hay coordenadas en los Puntos</span></ng-template>
    </div>
    <div class="relative">
      <div id="reportesMap" class="h-80 w-full rounded border border-slate-200"></div>
      <div class="pointer-events-none absolute bottom-2 right-2 rounded bg-white/70 px-1.5 py-0.5 text-[10px] text-slate-600">Origen (verde) | Destino (Índigo)</div>
    </div>
  </div>
</div>

<!-- Reporte Envíos vs Pagos -->
<div *ngIf="!loading && !error && activeTab==='resumen'" class="px-6 pb-6">
  <div class="mt-2">
    <div class="mb-2 text-sm font-medium text-slate-800">Envíos vs Pagos</div>
    <div class="overflow-x-auto rounded-md border border-slate-200 bg-white">
      <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-3 py-2 text-left">Comprobante</th>
            <th class="px-3 py-2 text-left">Remitente</th>
            <th class="px-3 py-2 text-left">Destinatario</th>
            <th class="px-3 py-2 text-left">Fecha envío</th>
            <th class="px-3 py-2 text-left">Fecha entrega</th>
            <th class="px-3 py-2 text-left">Pagado</th>
            <th class="px-3 py-2 text-left">Días desde entrega</th>
            <th class="px-3 py-2 text-right">Monto</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of filteredResumen" class="border-t border-slate-100">
            <td class="px-3 py-2">{{ row.comprobante }}</td>
            <td class="px-3 py-2">{{ row.remitente }}</td>
            <td class="px-3 py-2">{{ row.destinatario }}</td>
            <td class="px-3 py-2">{{ row.fecha_envio | ymd }}</td>
            <td class="px-3 py-2">{{ row.fecha_entrega | ymd }}</td>
            <td class="px-3 py-2">{{ row.pagado ? 'Sí' : 'No' }}</td>
            <td class="px-3 py-2">{{ row.dias_desde_entrega }}</td>
            <td class="px-3 py-2 text-right">{{ row.monto | number:'1.2-2' }}</td>
          </tr>
          <tr *ngIf="!filteredResumen.length">
            <td colspan="8" class="px-3 py-4 text-center text-slate-500">Sin resultados</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Reporte Manifiestos -->
<div *ngIf="!loading && !error && activeTab==='manifiestos'" class="px-6 pb-6">
  <div class="mt-2">
    <div class="mb-2 text-sm font-medium text-slate-800">Manifiestos</div>
    <div class="overflow-x-auto rounded-md border border-slate-200 bg-white">
      <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-3 py-2 text-left">Manifiesto</th>
            <th class="px-3 py-2 text-left">Conductor</th>
            <th class="px-3 py-2 text-right">N° envíos</th>
            <th class="px-3 py-2 text-right">Peso total</th>
            <th class="px-3 py-2 text-right">Ingresos generados</th>
            <th class="px-3 py-2 text-right">Ingresos promedio</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of resumenManifiestos" class="border-t border-slate-100">
            <td class="px-3 py-2">{{ row.manifiesto }}</td>
            <td class="px-3 py-2">{{ row.conductor }}</td>
            <td class="px-3 py-2 text-right">{{ row.numero_envios }}</td>
            <td class="px-3 py-2 text-right">{{ row.peso_total | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-right">{{ row.ingresos_generados | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-right">{{ row.ingreso_promedio | number:'1.2-2' }}</td>
          </tr>
          <tr *ngIf="!resumenManifiestos.length">
            <td colspan="6" class="px-3 py-4 text-center text-slate-500">Sin resultados</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Reporte Detracciones -->
<div *ngIf="!loading && !error && activeTab==='detracciones'" class="px-6 pb-6">
  <div class="mt-2">
    <div class="mb-2 text-sm font-medium text-slate-800">Detracciones</div>
    <div class="overflow-x-auto rounded-md border border-slate-200 bg-white">
      <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-3 py-2 text-left">Fecha emisión</th>
            <th class="px-3 py-2 text-left">Serie - Número</th>
            <th class="px-3 py-2 text-left">Cliente</th>
            <th class="px-3 py-2 text-left">Envío</th>
            <th class="px-3 py-2 text-right">Subtotal</th>
            <th class="px-3 py-2 text-right">IGV</th>
            <th class="px-3 py-2 text-right">Total</th>
            <th class="px-3 py-2 text-left">Código SPOT</th>
            <th class="px-3 py-2 text-right">% Det.</th>
            <th class="px-3 py-2 text-right">Base Det.</th>
            <th class="px-3 py-2 text-right">Monto Det.</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Fecha Depósito</th>
            <th class="px-3 py-2 text-left">N° Constancia</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of detracciones" class="border-t border-slate-100">
            <td class="px-3 py-2">{{ row.fecha_emision | ymd }}</td>
            <td class="px-3 py-2">{{ row.serie_numero }}</td>
            <td class="px-3 py-2">{{ row.cliente }}</td>
            <td class="px-3 py-2">{{ row.envio }}</td>
            <td class="px-3 py-2 text-right">{{ row.subtotal | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-right">{{ row.igv | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-right">{{ row.total | number:'1.2-2' }}</td>
            <td class="px-3 py-2">{{ row.codigo_spot }}</td>
            <td class="px-3 py-2 text-right">{{ row.porcentaje_det | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-right">{{ row.base_det | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-right">{{ row.monto_det | number:'1.2-2' }}</td>
            <td class="px-3 py-2">{{ row.estado_det }}</td>
            <td class="px-3 py-2">{{ row.fecha_deposito_det | ymd }}</td>
            <td class="px-3 py-2">{{ row.nro_constancia_det }}</td>
          </tr>
          <tr *ngIf="!detracciones.length">
            <td colspan="14" class="px-3 py-4 text-center text-slate-500">Sin resultados</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
