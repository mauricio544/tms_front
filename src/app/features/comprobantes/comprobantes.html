<div *ngIf="show" class="fixed inset-0 z-[2000] flex items-center justify-center">
  <div class="absolute inset-0 bg-black/30" (click)="onClose()"></div>
  <div class="relative z-10 w-full max-w-3xl rounded-lg bg-white p-6 shadow-lg">
    <div class="mb-4 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-800">Generar comprobante</h2>
      <button (click)="onClose()" class="rounded-md border border-slate-200 bg-white px-2 py-1 text-sm hover:bg-slate-50">Cerrar</button>
    </div>

    <!-- Cabecera del comprobante -->
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-700">Tipo comprobante</label>
          <select [(ngModel)]="cabecera.tipo_comprobante" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary">
            <option [ngValue]="undefined">Seleccione...</option>
            <option *ngFor="let t of tiposComprobante" [ngValue]="t.id">{{ t.nombre }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-700">N° comprobante</label>
          <input type="text" [(ngModel)]="cabecera.numero_comprobante" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-700">Forma de pago</label>
          <select [(ngModel)]="cabecera.forma_pago" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary">
            <option [ngValue]="undefined">Seleccione...</option>
            <option *ngFor="let f of formasPago" [ngValue]="f.id">{{ f.nombre }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-700">Fecha</label>
          <input type="date" [(ngModel)]="cabecera.fecha_comprobante" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-700">Serie</label>
          <input type="text" [(ngModel)]="cabecera.serie" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        </div>
        <div>
          <label class="block text-sm text-slate-700">Número</label>
          <input type="text" [(ngModel)]="cabecera.numero" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-700">Impuesto</label>
          <input type="number" [(ngModel)]="cabecera.impuesto" min="0" step="0.01" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        </div>
        <div>
          <label class="block text-sm text-slate-700">Precio total</label>
          <input type="number" [(ngModel)]="cabecera.precio_total" min="0" step="0.01" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        </div>
      </div>

      <div class="flex items-center justify-between">
        <div class="text-xs text-slate-600" *ngIf="!cabeceraId">Complete los campos y guarde la cabecera</div>
        <div class="text-xs text-green-600" *ngIf="cabeceraId">Cabecera guardada. ID: {{ cabeceraId }}</div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-red-600" *ngIf="errorCabecera">{{ errorCabecera }}</span>
          <button (click)="guardarCabecera()" [disabled]="guardandoCabecera || !validaCabecera" class="rounded-md bg-[#263238] px-3 py-2 text-sm font-medium text-white hover:bg-[#263238]/90 disabled:opacity-50">Guardar cabecera</button>
        </div>
      </div>
    </div>

    <!-- Detalle -->
    <div class="mt-6">
      <div class="mb-2 flex items-center justify-between">
        <h3 class="text-md font-medium text-slate-800">Detalle</h3>
        <div class="text-xs text-slate-600">Items: {{ detalle.length }}</div>
      </div>

      <div class="grid grid-cols-4 gap-2" [class.opacity-50]="!cabeceraId">
        <input type="number" placeholder="Cantidad" [(ngModel)]="nuevoItem.cantidad" min="0" step="1" class="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        <input type="text" placeholder="Descripción" [(ngModel)]="nuevoItem.descripcion" class="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        <input type="number" placeholder="Precio unitario" [(ngModel)]="nuevoItem.precio_unitario" min="0" step="0.01" class="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-primary" />
        <button (click)="agregarItem()" [disabled]="!cabeceraId || !validaItem" class="rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-white hover:bg-slate-900 disabled:opacity-50">Agregar</button>
      </div>
      <div class="text-xs text-red-600 mt-1" *ngIf="errorDetalle">{{ errorDetalle }}</div>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-600">
            <tr>
              <th class="px-2 py-1">Ítem</th>
              <th class="px-2 py-1">Cantidad</th>
              <th class="px-2 py-1">Descripción</th>
              <th class="px-2 py-1">P. Unitario</th>
              <th class="px-2 py-1">Subtotal</th>
              <th class="px-2 py-1"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of detalle; index as i" class="border-t border-slate-200">
              <td class="px-2 py-1">{{ it.numero_item }}</td>
              <td class="px-2 py-1">{{ it.cantidad }}</td>
              <td class="px-2 py-1">{{ it.descripcion }}</td>
              <td class="px-2 py-1">{{ it.precio_unitario | number: '1.2-2' }}</td>
              <td class="px-2 py-1">{{ (it.cantidad || 0) * (it.precio_unitario || 0) | number: '1.2-2' }}</td>
              <td class="px-2 py-1 text-right">
                <button class="rounded-md border border-[#2F455C]/20 bg-[#2F455C]/10 px-2 py-1 text-xs text-[#2F455C] hover:bg-[#2F455C]/20" (click)="eliminarItem(it)">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-slate-700">
          Total calculado: <span class="font-semibold">{{ totalCalculado | number: '1.2-2' }}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-600" *ngIf="cabeceraId">Actualiza precio_total con el total calculado</span>
          <button (click)="actualizarTotal()" [disabled]="!cabeceraId" class="rounded-md border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">Actualizar total</button>
          <button (click)="finalizar()" [disabled]="!cabeceraId || finalizando" class="rounded-md bg-[#263238] px-3 py-2 text-sm font-medium text-white hover:bg-[#263238]/90">Finalizar</button><span class="text-xs text-red-600" *ngIf="errorMovimiento">{{ errorMovimiento }}</span>
        </div>
      </div>
    </div>
  </div>
</div>



